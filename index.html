<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½œæ–‡ç´ ææ‰“ç£¨å™¨</title>
    <style>
        :root {
            /* ä¸»è‰²è°ƒ - æ¸…æ–°ç»¿ */
            --primary: #4CAF50;
            --primary-light: #81C784;
            --primary-dark: #388E3C;
            --primary-50: #E8F5E9;

            /* è¾…åŠ©è‰² */
            --secondary: #2196F3;
            --secondary-light: #64B5F6;
            --accent: #FF9800;
            --accent-light: #FFB74D;

            /* ä¸­æ€§è‰² */
            --bg-primary: #FAFAFA;
            --bg-secondary: #F5F5F5;
            --surface: #FFFFFF;
            --border: #E0E0E0;
            --divider: #EEEEEE;

            /* æ–‡å­— */
            --text-primary: #212121;
            --text-secondary: #757575;
            --text-hint: #9E9E9E;

            /* è¯„åˆ†é¢œè‰² */
            --score-high: #4CAF50;
            --score-mid: #FFC107;
            --score-low: #F44336;

            /* é˜´å½± */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);

            /* åœ†è§’ */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;

            /* é—´è· */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* å¸ƒå±€ */
        .app-container {
            max-width: 900px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* å¤´éƒ¨å¯¼èˆª */
        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .logo-icon {
            font-size: 1.5rem;
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .btn-icon {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            padding: var(--spacing-lg);
        }

        .view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        /* æ­¥éª¤æŒ‡ç¤ºå™¨ */
        .steps {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            gap: var(--spacing-md);
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all 0.3s;
        }

        .step.pending .step-circle {
            background: var(--bg-secondary);
            color: var(--text-hint);
            border: 2px solid var(--border);
        }

        .step.active .step-circle {
            background: var(--primary);
            color: white;
            box-shadow: 0 0 0 4px var(--primary-50);
        }

        .step.completed .step-circle {
            background: var(--primary-light);
            color: white;
        }

        .step-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .step.active .step-label {
            color: var(--primary-dark);
            font-weight: 600;
        }

        .step-connector {
            width: 60px;
            height: 2px;
            background: var(--border);
            margin-top: -20px;
        }

        .step-connector.completed {
            background: var(--primary-light);
        }

        /* æ¬¢è¿åŒºåŸŸ */
        .welcome-section {
            text-align: center;
            padding: var(--spacing-xl) 0;
        }

        .welcome-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        .welcome-desc {
            color: var(--text-secondary);
            max-width: 500px;
            margin: 0 auto var(--spacing-xl);
            line-height: 1.8;
        }

        /* è¡¨å•å…ƒç´  */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-textarea {
            width: 100%;
            min-height: 200px;
            padding: var(--spacing-md);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            line-height: 1.8;
            resize: vertical;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-50);
        }

        .form-textarea::placeholder {
            color: var(--text-hint);
        }

        .form-select {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--surface);
            cursor: pointer;
        }

        /* æ ‡ç­¾è¾“å…¥ */
        .tags-input-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            align-items: center;
            padding: var(--spacing-sm);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            min-height: 44px;
        }

        .tags-input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-50);
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--primary-50);
            color: var(--primary-dark);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        .tags-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 100px;
            padding: var(--spacing-xs);
            font-size: 0.875rem;
        }

        /* æŒ‰é’® */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-xl);
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:disabled {
            background: var(--text-hint);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .btn-accent:hover {
            background: #F57C00;
        }

        .btn-lg {
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: 1.125rem;
        }

        /* æ“ä½œæ  */
        .action-bar {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
            margin-top: var(--spacing-xl);
            flex-wrap: wrap;
        }

        /* å°è´´å£« */
        .tip-box {
            background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
            border-left: 4px solid var(--accent);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            color: #5D4037;
            font-size: 0.875rem;
        }

        .tip-box strong {
            color: var(--accent);
        }

        /* è¯„åˆ†ç»“æœé¡µ */
        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .score-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            text-align: center;
            border: 1px solid var(--border);
        }

        .score-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .score-stars {
            font-size: 1.5rem;
            margin-bottom: var(--spacing-sm);
            letter-spacing: 2px;
        }

        .score-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: var(--spacing-xs);
        }

        .score-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .overall-score {
            background: linear-gradient(135deg, var(--primary-50) 0%, #C8E6C9 100%);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            text-align: center;
            border: 1px solid var(--primary-light);
        }

        .overall-label {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .overall-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: var(--spacing-md);
        }

        .overall-comment {
            font-size: 1rem;
            color: var(--text-primary);
            line-height: 1.8;
            max-width: 600px;
            margin: 0 auto;
        }

        /* å»ºè®®åˆ—è¡¨ */
        .suggestions-list {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
        }

        .suggestion-item {
            display: flex;
            gap: var(--spacing-md);
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid var(--divider);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-num {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .suggestion-text {
            flex: 1;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* ä¸€æå¤šç”¨å¡ç‰‡ */
        .pivot-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            transition: all 0.2s;
        }

        .pivot-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .pivot-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--primary-50);
        }

        .pivot-icon {
            font-size: 1.5rem;
        }

        .pivot-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .pivot-topics {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }

        .pivot-section {
            margin-bottom: var(--spacing-md);
        }

        .pivot-section-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: var(--spacing-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .pivot-section-content {
            font-size: 0.9375rem;
            color: var(--text-primary);
            line-height: 1.8;
            padding-left: var(--spacing-md);
        }

        .pivot-example {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            font-style: italic;
            color: var(--text-secondary);
            border-left: 3px solid var(--primary);
        }

        /* ç´ æåº“ */
        .library-toolbar {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .library-search {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .library-search input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md) var(--spacing-sm) 36px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }

        .library-search-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-hint);
        }

        .library-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            transition: all 0.2s;
        }

        .library-item:hover {
            box-shadow: var(--shadow-md);
        }

        .library-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--spacing-sm);
        }

        .library-item-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .library-item-date {
            font-size: 0.75rem;
            color: var(--text-hint);
        }

        .library-item-tags {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
            margin-bottom: var(--spacing-md);
        }

        .library-item-tag {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--primary-50);
            color: var(--primary-dark);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
        }

        .library-item-meta {
            display: flex;
            gap: var(--spacing-lg);
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--divider);
        }

        .library-item-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-md);
            font-size: 0.875rem;
        }

        /* çŸ¥è¯†åº“ */
        .knowledge-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .knowledge-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            text-align: center;
            border: 2px solid var(--border);
            transition: all 0.2s;
        }

        .knowledge-card.enabled {
            border-color: var(--primary);
            background: var(--primary-50);
        }

        .knowledge-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }

        .knowledge-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .knowledge-status-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: var(--primary-50);
        }

        .upload-zone.dragover {
            border-color: var(--primary);
            background: var(--primary-50);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: var(--spacing-md);
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .upload-hint {
            font-size: 0.75rem;
            color: var(--text-hint);
        }

        .file-preview {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .analysis-result {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-top: var(--spacing-lg);
        }

        .analysis-section {
            margin-bottom: var(--spacing-lg);
        }

        .analysis-section-title {
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .stat-bar {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
        }

        .stat-bar-fill {
            flex: 1;
            height: 8px;
            background: var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .stat-bar-progress {
            height: 100%;
            background: var(--primary);
            border-radius: var(--radius-sm);
            transition: width 0.5s ease;
        }

        .stat-bar-label {
            font-size: 0.875rem;
            min-width: 80px;
        }

        .stat-bar-value {
            font-size: 0.75rem;
            color: var(--text-secondary);
            min-width: 50px;
            text-align: right;
        }

        /* è®¾ç½®æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: var(--spacing-md);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-hint);
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-50);
        }

        .help-text {
            font-size: 0.75rem;
            color: var(--text-hint);
            margin-top: var(--spacing-xs);
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 2000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--primary-50);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--spacing-md);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl) 0;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }

        /* åº•éƒ¨å¯¼èˆª */
        .bottom-nav {
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: var(--spacing-sm) 0;
            position: sticky;
            bottom: 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-lg);
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
            border: none;
            background: none;
            font-size: 0.75rem;
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 1.25rem;
        }

        /* åŸå§‹ç´ æå±•ç¤º */
        .source-material {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            border-left: 3px solid var(--secondary);
        }

        .source-material-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .source-material-content {
            color: var(--text-primary);
            line-height: 1.8;
            font-size: 0.9375rem;
        }

        /* å“åº”å¼ */
        @media (max-width: 600px) {
            .main-content {
                padding: var(--spacing-md);
            }

            .card {
                padding: var(--spacing-md);
            }

            .score-grid {
                grid-template-columns: 1fr;
            }

            .action-bar {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* APIå¯†é’¥æç¤º */
        .api-warning {
            background: #FFF3E0;
            border-left: 4px solid var(--accent);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .api-warning-text {
            flex: 1;
            font-size: 0.875rem;
            color: #5D4037;
        }

        /* éšè—æ–‡ä»¶è¾“å…¥ */
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">ğŸ“</span>
                <span>ä½œæ–‡ç´ ææ‰“ç£¨å™¨</span>
            </div>
            <div class="header-actions">
                <button class="btn-icon" onclick="app.showView('knowledge')">ğŸ“š çŸ¥è¯†åº“</button>
                <button class="btn-icon" onclick="app.showSettings()">âš™ï¸ è®¾ç½®</button>
            </div>
        </header>

        <!-- ä¸»å†…å®¹ -->
        <main class="main-content">
            <!-- è¾“å…¥é¡µé¢ -->
            <div id="view-input" class="view active">
                <div class="card">
                    <div class="welcome-section">
                        <h1 class="welcome-title">æ¬¢è¿æ¥åˆ°ä½œæ–‡ç´ ææ‰“ç£¨å™¨ ğŸ‘‹</h1>
                        <p class="welcome-desc">
                            æŠŠä½ çš„æ—¥è®°ã€éšç¬”æˆ–ä½œæ–‡ç‰‡æ®µç²˜è´´åœ¨è¿™é‡Œï¼Œ<br>
                            AIè€å¸ˆä¼šå¸®ä½ è¯„åˆ†ã€æå»ºè®®ï¼Œè¿˜èƒ½å¸®ä½ æŠŠä¸€ä¸ªç´ æ<br>
                            å˜æˆé€‚åˆä¸åŒä½œæ–‡é¢˜ç›®çš„ç‰ˆæœ¬ï¼
                        </p>
                    </div>

                    <div class="form-group">
                        <textarea
                            id="material-input"
                            class="form-textarea"
                            placeholder="ç¤ºä¾‹ï¼šä¸Šå‘¨å…­æˆ‘å»å‚åŠ äº†å­¦æ ¡ç»„ç»‡çš„æ¤æ ‘æ´»åŠ¨ã€‚æ—©ä¸Šå…«ç‚¹æˆ‘ä»¬åœ¨æ ¡é—¨å£é›†åˆï¼Œç„¶ååå¤§å·´å»äº†éƒŠåŒºã€‚åˆ°äº†é‚£é‡Œï¼Œæˆ‘ä»¬æ¯ä¸ªäººé¢†äº†ä¸€æ£µå°æ ‘è‹—å¼€å§‹æŒ–å‘ç§æ ‘ã€‚è™½ç„¶å¾ˆç´¯ï¼Œä½†æ˜¯çœ‹åˆ°ç§å¥½çš„æ ‘å¾ˆæœ‰æˆå°±æ„Ÿ..."
                        ></textarea>
                    </div>

                    <div class="form-group" style="display: flex; gap: var(--spacing-lg); flex-wrap: wrap;">
                        <div>
                            <label class="form-label">é€‰æ‹©åˆ†ç±»</label>
                            <select id="category-select" class="form-select">
                                <option value="">è¯·é€‰æ‹©...</option>
                                <option value="growth">æˆé•¿æ„Ÿæ‚Ÿ</option>
                                <option value="emotion">æƒ…æ„Ÿä½“éªŒ</option>
                                <option value="quality">å“è´¨ä¿®å…»</option>
                                <option value="culture">æ–‡åŒ–ä¼ æ‰¿</option>
                                <option value="society">ç¤¾ä¼šè§‚å¯Ÿ</option>
                                <option value="nature">è‡ªç„¶æ„Ÿæ‚Ÿ</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label class="form-label">æ·»åŠ æ ‡ç­¾</label>
                            <div class="tags-input-wrapper" id="tags-wrapper">
                                <input
                                    type="text"
                                    id="tags-input"
                                    class="tags-input"
                                    placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦..."
                                >
                            </div>
                        </div>
                    </div>

                    <div class="action-bar">
                        <button class="btn btn-primary btn-lg" onclick="app.startPolish()" id="btn-start">
                            ğŸ” å¼€å§‹æ‰“ç£¨
                        </button>
                    </div>
                </div>

                <div class="tip-box">
                    <strong>ğŸ’¡ å°è´´å£«ï¼š</strong>å¥½çš„ç´ æè¦æœ‰å…·ä½“çš„æ—¶é—´ã€åœ°ç‚¹ã€äººç‰©å’Œç»†èŠ‚æå†™
                </div>
            </div>

            <!-- AIè¯„åˆ†é¡µé¢ -->
            <div id="view-score" class="view">
                <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
                <div class="steps">
                    <div class="step completed">
                        <div class="step-circle">âœ“</div>
                        <span class="step-label">è¾“å…¥ç´ æ</span>
                    </div>
                    <div class="step-connector completed"></div>
                    <div class="step active">
                        <div class="step-circle">ğŸ“Š</div>
                        <span class="step-label">AIè¯„åˆ†</span>
                    </div>
                    <div class="step-connector"></div>
                    <div class="step pending">
                        <div class="step-circle">ğŸ”„</div>
                        <span class="step-label">ä¸€æå¤šç”¨</span>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">ğŸ“Š AI è¯„åˆ†æŠ¥å‘Š</h2>

                    <div class="score-grid" id="score-grid">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <div class="overall-score">
                        <div class="overall-label">ğŸ’¡ ç»¼åˆè¯„åˆ†</div>
                        <div class="overall-value" id="overall-score">--</div>
                        <div class="overall-comment" id="overall-comment">--</div>
                    </div>

                    <h3 style="margin-bottom: var(--spacing-md); font-size: 1rem;">ğŸ“ æ”¹è¿›å»ºè®®</h3>
                    <div class="suggestions-list" id="suggestions-list">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <div class="action-bar">
                        <button class="btn btn-secondary" onclick="app.showView('input')">
                            â† é‡æ–°è¾“å…¥
                        </button>
                        <button class="btn btn-primary" onclick="app.generatePivots()">
                            æŸ¥çœ‹ä¸€æå¤šç”¨ â†’
                        </button>
                    </div>
                </div>
            </div>

            <!-- ä¸€æå¤šç”¨é¡µé¢ -->
            <div id="view-pivots" class="view">
                <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
                <div class="steps">
                    <div class="step completed">
                        <div class="step-circle">âœ“</div>
                        <span class="step-label">è¾“å…¥ç´ æ</span>
                    </div>
                    <div class="step-connector completed"></div>
                    <div class="step completed">
                        <div class="step-circle">âœ“</div>
                        <span class="step-label">AIè¯„åˆ†</span>
                    </div>
                    <div class="step-connector completed"></div>
                    <div class="step active">
                        <div class="step-circle">ğŸ”„</div>
                        <span class="step-label">ä¸€æå¤šç”¨</span>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">ğŸ”„ ä¸€æå¤šç”¨ï¼šåŒä¸€ä¸ªç´ æï¼Œå¤šç§ç”¨æ³•</h2>

                    <div class="source-material">
                        <div class="source-material-label">åŸå§‹ç´ æ</div>
                        <div class="source-material-content" id="pivot-source">--</div>
                    </div>

                    <div id="pivots-container">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <div class="action-bar">
                        <button class="btn btn-secondary" onclick="app.showView('score')">
                            â† è¿”å›è¯„åˆ†
                        </button>
                        <button class="btn btn-primary" onclick="app.saveMaterial()">
                            ğŸ’¾ ä¿å­˜åˆ°æˆ‘çš„ç´ æ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ç´ æåº“é¡µé¢ -->
            <div id="view-library" class="view">
                <div class="card">
                    <h2 class="card-title">ğŸ“š æˆ‘çš„ç´ æåº“</h2>

                    <div class="library-toolbar">
                        <div class="library-search">
                            <span class="library-search-icon">ğŸ”</span>
                            <input type="text" id="library-search" placeholder="æœç´¢ç´ æ..." oninput="app.filterLibrary()">
                        </div>
                        <select class="form-select" id="library-filter" onchange="app.filterLibrary()">
                            <option value="">å…¨éƒ¨åˆ†ç±»</option>
                            <option value="growth">æˆé•¿æ„Ÿæ‚Ÿ</option>
                            <option value="emotion">æƒ…æ„Ÿä½“éªŒ</option>
                            <option value="quality">å“è´¨ä¿®å…»</option>
                            <option value="culture">æ–‡åŒ–ä¼ æ‰¿</option>
                            <option value="society">ç¤¾ä¼šè§‚å¯Ÿ</option>
                            <option value="nature">è‡ªç„¶æ„Ÿæ‚Ÿ</option>
                        </select>
                    </div>

                    <div id="library-list">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- çŸ¥è¯†åº“é¡µé¢ -->
            <div id="view-knowledge" class="view">
                <div class="card">
                    <h2 class="card-title">ğŸ“š çŸ¥è¯†åº“ç®¡ç†</h2>

                    <div class="knowledge-status">
                        <div class="knowledge-card enabled">
                            <div class="knowledge-icon">ğŸ“‹</div>
                            <div class="knowledge-name">åŸºç¡€åˆ†ç±»</div>
                            <div class="knowledge-status-text">âœ… å·²å¯ç”¨</div>
                        </div>
                        <div class="knowledge-card" id="knowledge-beijing">
                            <div class="knowledge-icon">ğŸ“–</div>
                            <div class="knowledge-name">åŒ—äº¬ä¸­è€ƒçœŸé¢˜åº“</div>
                            <div class="knowledge-status-text" id="knowledge-beijing-status">â³ æœªå¯¼å…¥</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ã€å¯¼å…¥çœŸé¢˜èµ„æ–™ã€‘</label>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                            æ”¯æŒ Markdown (.md) æˆ– TXT (.txt) æ ¼å¼ã€‚å»ºè®®åŒ…å«ï¼šå†å¹´ä½œæ–‡é¢˜ç›®ã€é¢˜ç›®ç±»å‹ã€ä¸»é¢˜å€¾å‘ã€é«˜åˆ†è¦ç‚¹ç­‰ã€‚
                        </p>

                        <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
                            <div class="upload-icon">ğŸ“„</div>
                            <div class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ æˆ– ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                            <div class="upload-hint">æ”¯æŒ .md, .txt æ ¼å¼</div>
                        </div>
                        <input type="file" id="file-input" accept=".md,.txt" onchange="app.handleFileUpload(event)">

                        <div class="file-preview" id="file-preview" style="display: none;"></div>

                        <div style="margin-top: var(--spacing-md);">
                            <button class="btn btn-primary" onclick="app.analyzeKnowledge()" id="btn-analyze" disabled>
                                ğŸš€ å¼€å§‹AIåˆ†æ
                            </button>
                        </div>
                    </div>

                    <div class="analysis-result" id="analysis-result" style="display: none;">
                        <h3 style="margin-bottom: var(--spacing-md);">ğŸ“Š AIåˆ†æç»“æœ</h3>

                        <div class="analysis-section">
                            <div class="analysis-section-title">ğŸ“ˆ ä¸»é¢˜åˆ†å¸ƒç»Ÿè®¡</div>
                            <div id="theme-stats"></div>
                        </div>

                        <div class="analysis-section">
                            <div class="analysis-section-title">ğŸ”‘ é«˜é¢‘å…³é”®è¯</div>
                            <div id="keyword-stats"></div>
                        </div>

                        <div class="analysis-section">
                            <div class="analysis-section-title">ğŸ’¡ AIæ´å¯Ÿ</div>
                            <p id="ai-insights" style="font-size: 0.9375rem; color: var(--text-primary); line-height: 1.8;"></p>
                        </div>

                        <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap; margin-top: var(--spacing-lg);">
                            <span class="tag">âœ… å·²æ›´æ–°ç´ æåˆ†ç±»ä½“ç³»</span>
                            <span class="tag">âœ… å·²ä¼˜åŒ–AIè¯„åˆ†æ ‡å‡†</span>
                            <span class="tag">âœ… å·²æ›´æ–°ä¸€æå¤šç”¨æ¨èé€»è¾‘</span>
                        </div>
                    </div>

                    <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid var(--divider);">
                        <h3 style="margin-bottom: var(--spacing-md); font-size: 1rem;">ğŸ“ èµ„æ–™æ ¼å¼ç¤ºä¾‹</h3>
                        <pre style="background: var(--bg-primary); padding: var(--spacing-md); border-radius: var(--radius-md); font-size: 0.875rem; overflow-x: auto;"><code># åŒ—äº¬ä¸­è€ƒä½œæ–‡é¢˜ç›®æ±‡æ€» (2015-2024)

## 2024å¹´
- é¢˜ç›®ï¼š_____ï¼Œè®©æˆ‘å¿«ä¹
- ç±»å‹ï¼šåŠå‘½é¢˜ä½œæ–‡
- ä¸»é¢˜ï¼šæƒ…æ„Ÿä½“éªŒã€ä¸ªäººæˆé•¿
- é«˜åˆ†è¦ç‚¹ï¼šçœŸæƒ…å®æ„Ÿã€ç»†èŠ‚æå†™

## 2023å¹´
- é¢˜ç›®ï¼šæˆ‘è¯»åˆ°çš„åŒ—äº¬
- ç±»å‹ï¼šå‘½é¢˜ä½œæ–‡
- ä¸»é¢˜ï¼šæ–‡åŒ–ä¼ æ‰¿ã€å®¶å›½æƒ…æ€€
- é«˜åˆ†è¦ç‚¹ï¼šæ–‡åŒ–è®¤åŒã€ä¸ªäººä½“éªŒ
...</code></pre>
                    </div>
                </div>
            </div>
        </main>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="app.showView('input')" data-view="input">
                <span class="nav-icon">âœï¸</span>
                <span>è¾“å…¥</span>
            </button>
            <button class="nav-item" onclick="app.showView('library')" data-view="library">
                <span class="nav-icon">ğŸ“š</span>
                <span>ç´ æåº“</span>
            </button>
            <button class="nav-item" onclick="app.showView('knowledge')" data-view="knowledge">
                <span class="nav-icon">ğŸ“</span>
                <span>çŸ¥è¯†åº“</span>
            </button>
        </nav>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">âš™ï¸ è®¾ç½®</h3>
                <button class="modal-close" onclick="app.closeSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">AI æä¾›å•†</label>
                    <select id="ai-provider" class="form-select" style="width: 100%;" onchange="app.onProviderChange()">
                        <option value="openai">OpenAI (ChatGPT)</option>
                        <option value="claude">Anthropic Claude</option>
                        <option value="gemini">Google Gemini</option>
                        <option value="kimi">Moonshot Kimi</option>
                        <option value="minimax">MiniMax</option>
                        <option value="azure">Azure OpenAI</option>
                        <option value="openrouter">OpenRouter</option>
                        <option value="custom">è‡ªå®šä¹‰ API</option>
                    </select>
                </div>

                <!-- Claude è®¾ç½® -->
                <div id="claude-settings" class="provider-settings">
                    <div class="form-group">
                        <label class="form-label">Claude API å¯†é’¥</label>
                        <input type="password" id="claude-api-key" class="form-input" placeholder="sk-ant-...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">API åŸºç¡€ URLï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="claude-api-url" class="form-input" placeholder="https://api.anthropic.com/v1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹é€‰æ‹©</label>
                        <select id="claude-model" class="form-select" style="width: 100%;">
                            <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnetï¼ˆæ¨èï¼‰</option>
                            <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                            <option value="claude-3-haiku-20240307">Claude 3 Haikuï¼ˆæ›´å¿«ï¼‰</option>
                            <option value="claude-3-opus-20240229">Claude 3 Opusï¼ˆæ›´å¼ºï¼‰</option>
                        </select>
                    </div>
                </div>

                <!-- OpenAI è®¾ç½® -->
                <div id="openai-settings" class="provider-settings" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">OpenAI API å¯†é’¥</label>
                        <input type="password" id="openai-api-key" class="form-input" placeholder="sk-...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">API åŸºç¡€ URLï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="openai-api-url" class="form-input" placeholder="https://api.openai.com/v1">
                        <p class="help-text">å¦‚æœä½¿ç”¨ç¬¬ä¸‰æ–¹ä¸­è½¬æœåŠ¡ï¼Œå¯åœ¨æ­¤è®¾ç½®è‡ªå®šä¹‰APIåœ°å€</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹é€‰æ‹©</label>
                        <select id="openai-model" class="form-select" style="width: 100%;">
                            <option value="gpt-4o">GPT-4oï¼ˆæ¨èï¼‰</option>
                            <option value="gpt-4o-mini">GPT-4o Miniï¼ˆæ›´å¿«ï¼‰</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </select>
                    </div>
                </div>

                <!-- Gemini è®¾ç½® -->
                <div id="gemini-settings" class="provider-settings" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Gemini API å¯†é’¥</label>
                        <input type="password" id="gemini-api-key" class="form-input" placeholder="AIza...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹é€‰æ‹©</label>
                        <select id="gemini-model" class="form-select" style="width: 100%;">
                            <option value="gemini-1.5-pro">Gemini 1.5 Proï¼ˆæ¨èï¼‰</option>
                            <option value="gemini-1.5-flash">Gemini 1.5 Flashï¼ˆæ›´å¿«ï¼‰</option>
                            <option value="gemini-1.0-pro">Gemini 1.0 Pro</option>
                        </select>
                    </div>
                </div>

                <!-- Kimi è®¾ç½® -->
                <div id="kimi-settings" class="provider-settings" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Moonshot API å¯†é’¥</label>
                        <input type="password" id="kimi-api-key" class="form-input" placeholder="sk-...">
                        <p class="help-text">åœ¨ <a href="https://platform.moonshot.cn/" target="_blank">Moonshot æ§åˆ¶å°</a> è·å– API Key</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹é€‰æ‹©</label>
                        <select id="kimi-model" class="form-select" style="width: 100%;">
                            <option value="moonshot-v1-8k">moonshot-v1-8kï¼ˆæ¨èï¼Œæ–°æ‰‹é¦–é€‰ï¼‰</option>
                            <option value="moonshot-v1-32k">moonshot-v1-32k</option>
                            <option value="moonshot-v1-128k">moonshot-v1-128kï¼ˆéœ€é¢å¤–æƒé™ï¼‰</option>
                        </select>
                        <p class="help-text">é¦–æ¬¡ä½¿ç”¨å»ºè®®é€‰æ‹© 8k æ¨¡å‹ï¼Œç¡®è®¤å¯ç”¨åå†å°è¯•å…¶ä»–æ¨¡å‹</p>
                    </div>
                </div>

                <!-- MiniMax è®¾ç½® -->
                <div id="minimax-settings" class="provider-settings" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">MiniMax API å¯†é’¥</label>
                        <input type="password" id="minimax-api-key" class="form-input" placeholder="...">
                        <p class="help-text">åœ¨ <a href="https://platform.minimaxi.com/" target="_blank">MiniMax æ§åˆ¶å°</a> è·å– API Key</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Group ID</label>
                        <input type="text" id="minimax-group-id" class="form-input" placeholder="ä¾‹å¦‚ï¼š1234567890">
                        <p class="help-text">åœ¨ MiniMax æ§åˆ¶å°ã€Œè´¦æˆ·ç®¡ç†ã€é¡µé¢è·å– Group IDï¼ˆçº¯æ•°å­—ï¼‰</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹é€‰æ‹©</label>
                        <select id="minimax-model" class="form-select" style="width: 100%;">
                            <option value="abab6.5s-chat">abab6.5s-chatï¼ˆæ¨èï¼‰</option>
                            <option value="abab6.5t-chat">abab6.5t-chat</option>
                            <option value="abab6.5g-chat">abab6.5g-chat</option>
                            <option value="abab5.5s-chat">abab5.5s-chat</option>
                        </select>
                        <p class="help-text">ç¡®ä¿åœ¨ MiniMax æ§åˆ¶å°å·²å¼€é€šå¯¹åº”æ¨¡å‹çš„ä½¿ç”¨æƒé™</p>
                    </div>
                </div>

                <!-- Azure OpenAI è®¾ç½® -->
                <div id="azure-settings" class="provider-settings" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Azure API å¯†é’¥</label>
                        <input type="password" id="azure-api-key" class="form-input" placeholder="...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Endpoint URL</label>
                        <input type="text" id="azure-endpoint" class="form-input" placeholder="https://your-resource.openai.azure.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">éƒ¨ç½²åç§°</label>
                        <input type="text" id="azure-deployment" class="form-input" placeholder="your-deployment-name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">API ç‰ˆæœ¬</label>
                        <select id="azure-api-version" class="form-select" style="width: 100%;">
                            <option value="2024-02-01">2024-02-01</option>
                            <option value="2024-05-01-preview">2024-05-01-preview</option>
                            <option value="2023-12-01-preview">2023-12-01-preview</option>
                        </select>
                    </div>
                </div>

                <!-- OpenRouter è®¾ç½® -->
                <div id="openrouter-settings" class="provider-settings" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">OpenRouter API å¯†é’¥</label>
                        <input type="password" id="openrouter-api-key" class="form-input" placeholder="sk-or-...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹é€‰æ‹©</label>
                        <select id="openrouter-model" class="form-select" style="width: 100%;">
                            <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                            <option value="anthropic/claude-3-sonnet">Claude 3 Sonnet</option>
                            <option value="openai/gpt-4o">GPT-4o</option>
                            <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                            <option value="google/gemini-1.5-pro">Gemini 1.5 Pro</option>
                            <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B</option>
                            <option value="deepseek/deepseek-chat">DeepSeek Chat</option>
                        </select>
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰ API è®¾ç½® -->
                <div id="custom-settings" class="provider-settings" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">API å¯†é’¥</label>
                        <input type="password" id="custom-api-key" class="form-input" placeholder="your-api-key">
                    </div>
                    <div class="form-group">
                        <label class="form-label">API åŸºç¡€ URL</label>
                        <input type="text" id="custom-api-url" class="form-input" placeholder="https://api.example.com/v1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹åç§°</label>
                        <input type="text" id="custom-model" class="form-input" placeholder="model-name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è¯·æ±‚æ ¼å¼</label>
                        <select id="custom-format" class="form-select" style="width: 100%;">
                            <option value="openai">OpenAI å…¼å®¹æ ¼å¼</option>
                            <option value="anthropic">Anthropic æ ¼å¼</option>
                        </select>
                        <p class="help-text">é€‰æ‹©ä½ çš„ API ä½¿ç”¨çš„è¯·æ±‚æ ¼å¼</p>
                    </div>
                </div>

                <div class="form-group">
                    <p class="help-text">API å¯†é’¥ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeSettings()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="app.saveSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½é®ç½© -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">AIåˆ†æä¸­ï¼Œè¯·ç¨å€™...</div>
    </div>

    <script>
        // ==================== æ•°æ®å­˜å‚¨ ====================
        const Storage = {
            MATERIALS_KEY: 'essay_materials',
            KNOWLEDGE_KEY: 'essay_knowledge',
            SETTINGS_KEY: 'essay_settings',

            getMaterials() {
                return JSON.parse(localStorage.getItem(this.MATERIALS_KEY) || '[]');
            },

            setMaterials(data) {
                localStorage.setItem(this.MATERIALS_KEY, JSON.stringify(data));
            },

            getKnowledge() {
                return JSON.parse(localStorage.getItem(this.KNOWLEDGE_KEY) || '{}');
            },

            setKnowledge(data) {
                localStorage.setItem(this.KNOWLEDGE_KEY, JSON.stringify(data));
            },

            getSettings() {
                return JSON.parse(localStorage.getItem(this.SETTINGS_KEY) || '{}');
            },

            setSettings(data) {
                localStorage.setItem(this.SETTINGS_KEY, JSON.stringify(data));
            }
        };

        // ==================== åŸºç¡€åˆ†ç±» ====================
        const BASE_CATEGORIES = {
            version: "1.0",
            source: "starter",
            themes: [
                { id: 'growth', name: 'æˆé•¿æ„Ÿæ‚Ÿ', description: 'ä¸ªäººæˆé•¿ã€å…‹æœå›°éš¾ã€è‡ªæˆ‘çªç ´' },
                { id: 'emotion', name: 'æƒ…æ„Ÿä½“éªŒ', description: 'äº²æƒ…ã€å‹æƒ…ã€å¸ˆç”Ÿæƒ…ã€äººé—´æ¸©æš–' },
                { id: 'quality', name: 'å“è´¨ä¿®å…»', description: 'è¯šä¿¡ã€åšæŒã€è´£ä»»ã€å‹‡æ°”' },
                { id: 'culture', name: 'æ–‡åŒ–ä¼ æ‰¿', description: 'ä¼ ç»Ÿæ–‡åŒ–ã€å®¶å›½æƒ…æ€€ã€æ–‡åŒ–è‡ªä¿¡' },
                { id: 'society', name: 'ç¤¾ä¼šè§‚å¯Ÿ', description: 'ç¤¾ä¼šç°è±¡ã€æ—¶ä»£å˜è¿ã€äººæ–‡å…³æ€€' },
                { id: 'nature', name: 'è‡ªç„¶æ„Ÿæ‚Ÿ', description: 'è‡ªç„¶æ™¯è§‚ã€ç¯å¢ƒä¿æŠ¤ã€ç”Ÿå‘½æ€è€ƒ' }
            ],
            tags: ['åšæŒ', 'æˆé•¿', 'äº²æƒ…', 'å‹æƒ…', 'ä¼ ç»Ÿæ–‡åŒ–', 'è´£ä»»', 'ç¯ä¿', 'åˆ›æ–°', 'å›¢é˜Ÿ', 'æŒ«æŠ˜']
        };

        // ==================== åº”ç”¨ä¸»é€»è¾‘ ====================
        const app = {
            currentMaterial: null,
            currentScore: null,
            currentPivots: null,
            uploadedFileContent: null,

            init() {
                this.loadSettings();
                this.initTagsInput();
                this.initDragDrop();
                this.updateKnowledgeStatus();
            },

            // è§†å›¾åˆ‡æ¢
            showView(viewName) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(`view-${viewName}`).classList.add('active');

                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelector(`.nav-item[data-view="${viewName}"]`)?.classList.add('active');

                if (viewName === 'library') {
                    this.loadLibrary();
                }
            },

            // æ ‡ç­¾è¾“å…¥
            initTagsInput() {
                const input = document.getElementById('tags-input');
                const wrapper = document.getElementById('tags-wrapper');

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && input.value.trim()) {
                        e.preventDefault();
                        this.addTag(input.value.trim());
                        input.value = '';
                    }
                    if (e.key === 'Backspace' && !input.value) {
                        const tags = wrapper.querySelectorAll('.tag');
                        if (tags.length > 0) {
                            tags[tags.length - 1].remove();
                        }
                    }
                });
            },

            addTag(text) {
                const wrapper = document.getElementById('tags-wrapper');
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.innerHTML = `${text} <span class="tag-remove" onclick="this.parentElement.remove()">Ã—</span>`;
                wrapper.insertBefore(tag, document.getElementById('tags-input'));
            },

            getTags() {
                return Array.from(document.querySelectorAll('#tags-wrapper .tag')).map(t =>
                    t.textContent.replace('Ã—', '').trim()
                );
            },

            // æ‹–æ‹½ä¸Šä¼ 
            initDragDrop() {
                const zone = document.getElementById('upload-zone');

                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('dragover');
                });

                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('dragover');
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file) this.processFile(file);
                });
            },

            // å¼€å§‹æ‰“ç£¨
            async startPolish() {
                const content = document.getElementById('material-input').value.trim();
                const category = document.getElementById('category-select').value;

                if (!content) {
                    alert('è¯·å…ˆè¾“å…¥ç´ æå†…å®¹');
                    return;
                }

                const settings = Storage.getSettings();
                if (!this.hasValidAPIKey(settings)) {
                    alert('è¯·å…ˆé…ç½®APIå¯†é’¥ï¼ˆç‚¹å‡»å³ä¸Šè§’è®¾ç½®ï¼‰');
                    this.showSettings();
                    return;
                }

                this.currentMaterial = {
                    content,
                    category,
                    tags: this.getTags(),
                    createdAt: Date.now()
                };

                this.showLoading('AIè¯„åˆ†ä¸­ï¼Œè¯·ç¨å€™...');

                try {
                    const score = await this.callAIAPI('score', content);
                    this.currentScore = score;
                    this.renderScore(score);
                    this.showView('score');
                } catch (err) {
                    alert('è¯„åˆ†å¤±è´¥ï¼š' + err.message);
                } finally {
                    this.hideLoading();
                }
            },

            // è°ƒç”¨Claude API
            async callClaudeAPI(type, content) {
                return this.callAIAPI(type, content);
            },

            // é€šç”¨ AI API è°ƒç”¨
            async callAIAPI(type, content) {
                const settings = Storage.getSettings();
                const knowledge = Storage.getKnowledge();
                const provider = settings.provider || 'claude';

                const prompts = this.buildPrompt(type, content, knowledge);

                switch (provider) {
                    case 'openai':
                        return this.callOpenAIAPI(prompts, settings);
                    case 'claude':
                        return this.callAnthropicAPI(prompts, settings);
                    case 'gemini':
                        return this.callGeminiAPI(prompts, settings);
                    case 'kimi':
                        return this.callKimiAPI(prompts, settings);
                    case 'minimax':
                        return this.callMiniMaxAPI(prompts, settings);
                    case 'azure':
                        return this.callAzureAPI(prompts, settings);
                    case 'openrouter':
                        return this.callOpenRouterAPI(prompts, settings);
                    case 'custom':
                        return this.callCustomAPI(prompts, settings);
                    default:
                        throw new Error('æœªçŸ¥çš„ AI æä¾›å•†: ' + provider);
                }
            },

            // OpenAI API
            async callOpenAIAPI(prompts, settings) {
                const baseUrl = settings.openai?.apiUrl || 'https://api.openai.com/v1';
                const response = await fetch(`${baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${settings.openai?.apiKey}`
                    },
                    body: JSON.stringify({
                        model: settings.openai?.model || 'gpt-4o',
                        max_tokens: 2000,
                        messages: [{ role: 'user', content: prompts }]
                    })
                });

                if (!response.ok) {
                    const err = await response.text();
                    throw new Error(err);
                }

                const data = await response.json();
                const text = data.choices[0].message.content;
                return this.parseAIResponse(text);
            },

            // Anthropic Claude API
            async callAnthropicAPI(prompts, settings) {
                const baseUrl = settings.claude?.apiUrl || 'https://api.anthropic.com/v1';
                const response = await fetch(`${baseUrl}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': settings.claude?.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: settings.claude?.model || 'claude-3-5-sonnet-20241022',
                        max_tokens: 2000,
                        messages: [{ role: 'user', content: prompts }]
                    })
                });

                if (!response.ok) {
                    const err = await response.text();
                    throw new Error(err);
                }

                const data = await response.json();
                const text = data.content[0].text;
                return this.parseAIResponse(text);
            },

            // Google Gemini API
            async callGeminiAPI(prompts, settings) {
                const apiKey = settings.gemini?.apiKey;
                const model = settings.gemini?.model || 'gemini-1.5-pro';
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompts }] }],
                        generationConfig: {
                            maxOutputTokens: 2000,
                            temperature: 0.7
                        }
                    })
                });

                if (!response.ok) {
                    const err = await response.text();
                    throw new Error(err);
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                return this.parseAIResponse(text);
            },

            // Moonshot Kimi API
            // æ–‡æ¡£: https://platform.moonshot.cn/docs/api-reference/chat
            async callKimiAPI(prompts, settings) {
                const apiKey = settings.kimi?.apiKey;
                if (!apiKey) {
                    throw new Error('Kimi API å¯†é’¥æœªé…ç½®');
                }

                const response = await fetch('https://api.moonshot.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: settings.kimi?.model || 'moonshot-v1-8k',
                        temperature: 0.7,
                        max_tokens: 2000,
                        messages: [
                            { role: 'system', content: 'ä½ æ˜¯ä¸€ä½èµ„æ·±ä¸­è€ƒä½œæ–‡é˜…å·è€å¸ˆï¼Œæœ‰20å¹´é˜…å·ç»éªŒã€‚' },
                            { role: 'user', content: prompts }
                        ]
                    })
                });

                if (!response.ok) {
                    const status = response.status;
                    let errText = await response.text();
                    try {
                        const errJson = JSON.parse(errText);
                        errText = errJson.error?.message || errText;
                    } catch (e) {}

                    if (status === 401) {
                        throw new Error('Kimi API å¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥è®¾ç½®');
                    } else if (status === 429) {
                        throw new Error('Kimi API è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
                    } else if (status === 400) {
                        throw new Error('Kimi è¯·æ±‚å‚æ•°é”™è¯¯: ' + errText);
                    }
                    throw new Error(`Kimi API é”™è¯¯ (${status}): ${errText}`);
                }

                const data = await response.json();
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Kimi è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸: ' + JSON.stringify(data));
                }
                const text = data.choices[0].message.content;
                return this.parseAIResponse(text);
            },

            // MiniMax API - Anthropic SDK æ ¼å¼
            // æ–‡æ¡£: https://platform.minimaxi.com/docs/api-reference/text-anthropic-api
            async callMiniMaxAPI(prompts, settings) {
                const apiKey = settings.minimax?.apiKey;
                const groupId = settings.minimax?.groupId;

                if (!apiKey) {
                    throw new Error('MiniMax API å¯†é’¥æœªé…ç½®');
                }
                if (!groupId) {
                    throw new Error('MiniMax Group ID æœªé…ç½®');
                }

                // MiniMax Anthropic æ ¼å¼ API URL
                const url = `https://api.minimax.chat/v1/text/chatcompletion_pro?GroupId=${encodeURIComponent(groupId)}`;

                // Anthropic æ ¼å¼è¯·æ±‚ä½“
                const requestBody = {
                    model: settings.minimax?.model || 'abab6.5s-chat',
                    max_tokens: 2000,
                    messages: [
                        {
                            role: 'user',
                            content: 'ä½ æ˜¯ä¸€ä½èµ„æ·±ä¸­è€ƒä½œæ–‡é˜…å·è€å¸ˆï¼Œæœ‰20å¹´é˜…å·ç»éªŒã€‚\n\n' + prompts
                        }
                    ]
                };

                console.log('MiniMax Anthropic è¯·æ±‚:', { url, model: requestBody.model });

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const status = response.status;
                    let errData;
                    try {
                        errData = await response.json();
                    } catch (e) {
                        errData = { base_resp: { status_msg: await response.text() } };
                    }

                    const errorMsg = errData.base_resp?.status_msg || errData.error?.message || 'æœªçŸ¥é”™è¯¯';

                    if (status === 401 || status === 403) {
                        throw new Error('MiniMax API å¯†é’¥æˆ– Group ID æ— æ•ˆï¼Œè¯·æ£€æŸ¥è®¾ç½®');
                    } else if (status === 429) {
                        throw new Error('MiniMax API è¯·æ±‚è¿‡äºé¢‘ç¹æˆ–é¢åº¦ä¸è¶³');
                    } else if (errData.base_resp?.status_code === 1004) {
                        throw new Error('MiniMax æ¨¡å‹æœªæˆæƒï¼Œè¯·ç¡®è®¤å·²å¼€é€šè¯¥æ¨¡å‹æƒé™');
                    }
                    throw new Error(`MiniMax API é”™è¯¯ (${status}): ${errorMsg}`);
                }

                const data = await response.json();
                console.log('MiniMax Anthropic å“åº”:', data);

                // Anthropic æ ¼å¼: data.content[0].text
                let text = null;

                if (data.content && data.content[0] && data.content[0].text) {
                    text = data.content[0].text;
                }

                // å¤‡é€‰: æ£€æŸ¥ data åµŒå¥—æ ¼å¼
                if (!text && data.data && data.data.content && data.data.content[0]) {
                    text = data.data.content[0].text;
                }

                // å¤‡é€‰: å°è¯• choices æ ¼å¼ï¼ˆå¦‚æœ MiniMax åŒæ—¶æ”¯æŒä¸¤ç§æ ¼å¼ï¼‰
                if (!text && data.choices && data.choices[0]) {
                    if (data.choices[0].message && data.choices[0].message.content) {
                        text = data.choices[0].message.content;
                    }
                }

                if (!text) {
                    throw new Error('MiniMax è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸: ' + JSON.stringify(data).substring(0, 300));
                }

                return this.parseAIResponse(text);
            },

            // Azure OpenAI API
            async callAzureAPI(prompts, settings) {
                const endpoint = settings.azure?.endpoint;
                const deployment = settings.azure?.deployment;
                const apiVersion = settings.azure?.apiVersion || '2024-02-01';
                const url = `${endpoint}/openai/deployments/${deployment}/chat/completions?api-version=${apiVersion}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': settings.azure?.apiKey
                    },
                    body: JSON.stringify({
                        max_tokens: 2000,
                        messages: [{ role: 'user', content: prompts }]
                    })
                });

                if (!response.ok) {
                    const err = await response.text();
                    throw new Error(err);
                }

                const data = await response.json();
                const text = data.choices[0].message.content;
                return this.parseAIResponse(text);
            },

            // OpenRouter API
            async callOpenRouterAPI(prompts, settings) {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${settings.openrouter?.apiKey}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'ä½œæ–‡ç´ ææ‰“ç£¨å™¨'
                    },
                    body: JSON.stringify({
                        model: settings.openrouter?.model || 'anthropic/claude-3.5-sonnet',
                        max_tokens: 2000,
                        messages: [{ role: 'user', content: prompts }]
                    })
                });

                if (!response.ok) {
                    const err = await response.text();
                    throw new Error(err);
                }

                const data = await response.json();
                const text = data.choices[0].message.content;
                return this.parseAIResponse(text);
            },

            // è‡ªå®šä¹‰ API
            async callCustomAPI(prompts, settings) {
                const baseUrl = settings.custom?.apiUrl;
                const format = settings.custom?.format || 'openai';
                const apiKey = settings.custom?.apiKey;
                const model = settings.custom?.model;

                let url, headers, body;

                if (format === 'openai') {
                    url = `${baseUrl}/chat/completions`;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                    body = JSON.stringify({
                        model: model,
                        max_tokens: 2000,
                        messages: [{ role: 'user', content: prompts }]
                    });
                } else {
                    // Anthropic format
                    url = `${baseUrl}/messages`;
                    headers = {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    };
                    body = JSON.stringify({
                        model: model,
                        max_tokens: 2000,
                        messages: [{ role: 'user', content: prompts }]
                    });
                }

                const response = await fetch(url, { method: 'POST', headers, body });

                if (!response.ok) {
                    const err = await response.text();
                    throw new Error(err);
                }

                const data = await response.json();
                let text;
                if (format === 'openai') {
                    text = data.choices[0].message.content;
                } else {
                    text = data.content[0].text;
                }
                return this.parseAIResponse(text);
            },

            // è§£æ AI å“åº”
            parseAIResponse(text) {
                try {
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                } catch (e) {
                    console.log('JSONè§£æå¤±è´¥ï¼Œè¿”å›åŸå§‹æ–‡æœ¬');
                }
                return { raw: text };
            },

            // æ„å»ºPrompt
            buildPrompt(type, content, knowledge) {
                const basePrompt = `ä½ æ˜¯ä¸€ä½èµ„æ·±ä¸­è€ƒä½œæ–‡é˜…å·è€å¸ˆï¼Œæœ‰20å¹´é˜…å·ç»éªŒã€‚è¯·ç”¨JSONæ ¼å¼è¿”å›ç»“æœã€‚\n\n`;

                const knowledgeText = knowledge.beijing?.enabled ? `
ã€åŒ—äº¬ä¸­è€ƒçœŸé¢˜çŸ¥è¯†åº“ã€‘
è¿‘10å¹´é«˜é¢‘ä¸»é¢˜ï¼š${knowledge.beijing.data?.stats?.topThemes?.map(t => t.name).join('ã€') || 'æˆé•¿æ„Ÿæ‚Ÿã€æƒ…æ„Ÿä½“éªŒã€å“è´¨ä¿®å…»'}
å‘½é¢˜è¶‹åŠ¿ï¼š${knowledge.beijing.data?.trends || 'æ³¨é‡çœŸæƒ…å®æ„Ÿå’Œç»†èŠ‚æå†™'}
é«˜åˆ†è¦ç´ ï¼š${knowledge.beijing.data?.highScoreFactors?.join('ã€') || 'çœŸæƒ…å®æ„Ÿã€ç»†èŠ‚ä¸°å¯Œã€ç»“æ„å®Œæ•´'}
` : '';

                if (type === 'score') {
                    return basePrompt + knowledgeText + `
è¯·å¯¹ä»¥ä¸‹å­¦ç”Ÿä½œæ–‡ç´ æè¿›è¡Œè¯„åˆ†å’Œåˆ†æï¼š

ã€ç´ æå†…å®¹ã€‘
${content}

è¯·ä»ä»¥ä¸‹ä¸‰ä¸ªç»´åº¦è¯„åˆ†ï¼ˆæ»¡åˆ†5.0åˆ†ï¼‰ï¼š
1. å†…å®¹å®Œæ•´åº¦ï¼šæ—¶é—´ã€åœ°ç‚¹ã€äººç‰©ã€äº‹ä»¶æ˜¯å¦æ¸…æ™°å®Œæ•´
2. ç»†èŠ‚ä¸°å¯Œåº¦ï¼šæ˜¯å¦æœ‰å…·ä½“çš„æ„Ÿå®˜ç»†èŠ‚ï¼ˆè§†è§‰ã€å¬è§‰ã€è§¦è§‰ã€å—…è§‰ï¼‰
3. æƒ…æ„ŸçœŸæŒšåº¦ï¼šæƒ…æ„Ÿæ˜¯å¦çœŸå®è‡ªç„¶ï¼Œæ˜¯å¦å‘è‡ªå†…å¿ƒ

è¯·è¿”å›ä»¥ä¸‹JSONæ ¼å¼ï¼š
{
  "scores": {
    "completeness": 4.0,
    "detail": 3.5,
    "authenticity": 4.5,
    "overall": 4.0
  },
  "summary": "æ€»ä½“è¯„ä»·æ–‡å­—",
  "suggestions": ["å»ºè®®1", "å»ºè®®2", "å»ºè®®3"]
}`;
                }

                if (type === 'pivot') {
                    const themes = knowledge.beijing?.enabled && knowledge.beijing.data?.themeCategories
                        ? knowledge.beijing.data.themeCategories.map(t => t.name).join('ã€')
                        : 'æˆé•¿æ„Ÿæ‚Ÿã€æƒ…æ„Ÿä½“éªŒã€å“è´¨ä¿®å…»ã€æ–‡åŒ–ä¼ æ‰¿ã€ç¤¾ä¼šè§‚å¯Ÿã€è‡ªç„¶æ„Ÿæ‚Ÿ';

                    return basePrompt + knowledgeText + `
è¯·é’ˆå¯¹ä»¥ä¸‹ç´ æï¼Œç”Ÿæˆ4ä¸ªä¸åŒçš„ä½œæ–‡ç«‹æ„è§’åº¦ï¼Œå®ç°"ä¸€æå¤šç”¨"ã€‚

ã€ç´ æå†…å®¹ã€‘
${content}

å‚è€ƒä¸»é¢˜ï¼š${themes}

è¦æ±‚ï¼š
1. æ¯ä¸ªè§’åº¦è¦æœ‰æ˜ç¡®çš„ä¸»é¢˜å®šä½
2. ç»™å‡ºé€‚é…çš„ä½œæ–‡é¢˜ç›®ç¤ºä¾‹
3. æä¾›å…·ä½“çš„å†™æ³•å»ºè®®
4. ç»™å‡ºä¸€ä¸ªç‰‡æ®µç¤ºä¾‹

è¯·è¿”å›ä»¥ä¸‹JSONæ ¼å¼ï¼š
{
  "pivots": [
    {
      "dimension": "è§’åº¦åç§°ï¼ˆå¦‚ï¼šåŠ³åŠ¨/æˆé•¿ï¼‰",
      "themes": ["æˆé•¿æ„Ÿæ‚Ÿ", "å“è´¨ä¿®å…»"],
      "topics": ["é‚£ä¸€æ¬¡ï¼Œæˆ‘æ‡‚å¾—äº†____", "åŠ³åŠ¨çš„å¿«ä¹"],
      "advice": "é‡ç‚¹å†™æƒ…æ„Ÿå˜åŒ–è¿‡ç¨‹...",
      "example": "ç‰‡æ®µç¤ºä¾‹æ–‡å­—"
    }
  ]
}`;
                }

                if (type === 'analyze') {
                    return basePrompt + `
ä½ æ˜¯ä¸€ä½ä¸­è€ƒä½œæ–‡ç ”ç©¶ä¸“å®¶ã€‚è¯·æ·±åº¦åˆ†æä»¥ä¸‹åŒ—äº¬ä¸­è€ƒä½œæ–‡èµ„æ–™ï¼š

ã€èµ„æ–™å†…å®¹ã€‘
${content}

è¯·æå–å¹¶è¿”å›ä»¥ä¸‹ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼‰ï¼š
{
  "years": ["2015", "2016", ...],
  "topics": [
    {
      "year": 2024,
      "title": "é¢˜ç›®åŸæ–‡",
      "type": "å‘½é¢˜/åŠå‘½é¢˜/ææ–™",
      "theme": "ä¸»é¢˜åˆ†ç±»",
      "keywords": ["å…³é”®è¯1", "å…³é”®è¯2"]
    }
  ],
  "stats": {
    "topThemes": [
      {"name": "ä¸»é¢˜å", "count": 12, "percentage": "35%"}
    ],
    "keywordFrequency": {"æˆé•¿": 15, "å¿«ä¹": 12}
  },
  "trends": "è¿‘10å¹´å‘½é¢˜è¶‹åŠ¿æ€»ç»“ï¼ˆ100å­—å·¦å³ï¼‰",
  "highScoreFactors": ["é«˜åˆ†è¦ç´ 1", "é«˜åˆ†è¦ç´ 2", "é«˜åˆ†è¦ç´ 3"],
  "themeCategories": [
    {"name": "åˆ†ç±»åç§°", "description": "åˆ†ç±»å®šä¹‰", "examples": ["ç¤ºä¾‹é¢˜ç›®"]}
  ]
}`;
                }
            },

            // æ¸²æŸ“è¯„åˆ†ç»“æœ
            renderScore(score) {
                const dimensionNames = {
                    completeness: { name: 'å†…å®¹å®Œæ•´åº¦', desc: 'äº‹ä»¶å®Œæ•´' },
                    detail: { name: 'ç»†èŠ‚ä¸°å¯Œåº¦', desc: 'æ„Ÿå®˜ç»†èŠ‚' },
                    authenticity: { name: 'æƒ…æ„ŸçœŸæŒšåº¦', desc: 'æƒ…æ„ŸçœŸå®' }
                };

                // æ¸²æŸ“å„ç»´åº¦è¯„åˆ†
                const grid = document.getElementById('score-grid');
                grid.innerHTML = Object.entries(score.scores || {})
                    .filter(([key]) => key !== 'overall')
                    .map(([key, value]) => {
                        const dim = dimensionNames[key] || { name: key, desc: '' };
                        const stars = 'â­'.repeat(Math.floor(value)) + (value % 1 >= 0.5 ? 'âœ¨' : '');
                        return `
                            <div class="score-card">
                                <div class="score-title">${dim.name}</div>
                                <div class="score-stars">${stars}</div>
                                <div class="score-value">${value}/5.0</div>
                                <div class="score-desc">${dim.desc}</div>
                            </div>
                        `;
                    }).join('');

                // æ¸²æŸ“ç»¼åˆè¯„åˆ†
                document.getElementById('overall-score').textContent =
                    (score.scores?.overall || '--') + '/5.0';
                document.getElementById('overall-comment').textContent =
                    score.summary || 'æš‚æ— è¯„ä»·';

                // æ¸²æŸ“å»ºè®®
                const suggestions = document.getElementById('suggestions-list');
                suggestions.innerHTML = (score.suggestions || [])
                    .map((s, i) => `
                        <div class="suggestion-item">
                            <span class="suggestion-num">${i + 1}</span>
                            <span class="suggestion-text">${s}</span>
                        </div>
                    `).join('');
            },

            // éªŒè¯ API å¯†é’¥
            hasValidAPIKey(settings) {
                const provider = settings.provider || 'claude';
                switch (provider) {
                    case 'openai':
                        return !!settings.openai?.apiKey;
                    case 'claude':
                        return !!settings.claude?.apiKey;
                    case 'gemini':
                        return !!settings.gemini?.apiKey;
                    case 'kimi':
                        return !!settings.kimi?.apiKey;
                    case 'minimax':
                        return !!settings.minimax?.apiKey && !!settings.minimax?.groupId;
                    case 'azure':
                        return !!settings.azure?.apiKey && !!settings.azure?.endpoint && !!settings.azure?.deployment;
                    case 'openrouter':
                        return !!settings.openrouter?.apiKey;
                    case 'custom':
                        return !!settings.custom?.apiKey && !!settings.custom?.apiUrl && !!settings.custom?.model;
                    default:
                        return false;
                }
            },

            // ç”Ÿæˆä¸€æå¤šç”¨
            async generatePivots() {
                const settings = Storage.getSettings();
                if (!this.hasValidAPIKey(settings)) {
                    alert('è¯·å…ˆé…ç½®APIå¯†é’¥');
                    this.showSettings();
                    return;
                }

                this.showLoading('ç”Ÿæˆå¤šè§’åº¦åˆ†æä¸­ï¼Œè¯·ç¨å€™...');

                try {
                    const result = await this.callAIAPI('pivot', this.currentMaterial.content);
                    this.currentPivots = result;
                    this.renderPivots(result);
                    this.showView('pivots');
                } catch (err) {
                    alert('ç”Ÿæˆå¤±è´¥ï¼š' + err.message);
                } finally {
                    this.hideLoading();
                }
            },

            // æ¸²æŸ“ä¸€æå¤šç”¨
            renderPivots(result) {
                document.getElementById('pivot-source').textContent =
                    this.currentMaterial.content.substring(0, 100) + '...';

                const icons = ['ğŸŒ±', 'ğŸŒ¿', 'ğŸ¤', 'â°'];
                const container = document.getElementById('pivots-container');

                container.innerHTML = (result.pivots || []).map((pivot, i) => `
                    <div class="pivot-card">
                        <div class="pivot-header">
                            <span class="pivot-icon">${icons[i] || 'ğŸ“'}</span>
                            <span class="pivot-title">è§’åº¦${i + 1}ï¼š${pivot.dimension}</span>
                        </div>

                        <div class="pivot-topics">
                            <strong>é€‚é…é¢˜ç›®ï¼š</strong>${pivot.topics?.join('ã€') || 'æš‚æ— '}
                        </div>

                        <div class="pivot-section">
                            <div class="pivot-section-label">ğŸ’¡ å†™æ³•å»ºè®®</div>
                            <div class="pivot-section-content">${pivot.advice}</div>
                        </div>

                        <div class="pivot-section">
                            <div class="pivot-section-label">ğŸ“ ç‰‡æ®µç¤ºä¾‹</div>
                            <div class="pivot-example">${pivot.example}</div>
                        </div>
                    </div>
                `).join('');
            },

            // ä¿å­˜ç´ æ
            saveMaterial() {
                if (!this.currentMaterial) return;

                const material = {
                    ...this.currentMaterial,
                    id: Date.now().toString(),
                    scores: this.currentScore?.scores,
                    summary: this.currentScore?.summary,
                    suggestions: this.currentScore?.suggestions,
                    pivots: this.currentPivots?.pivots
                };

                const materials = Storage.getMaterials();
                materials.unshift(material);
                Storage.setMaterials(materials);

                alert('ç´ æå·²ä¿å­˜ï¼');
                this.showView('library');
            },

            // åŠ è½½ç´ æåº“
            loadLibrary() {
                const materials = Storage.getMaterials();
                const container = document.getElementById('library-list');

                if (materials.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <p>è¿˜æ²¡æœ‰ä¿å­˜çš„ç´ æ</p>
                            <p style="font-size: 0.875rem; margin-top: var(--spacing-sm);">
                                å»<a href="#" onclick="app.showView('input')">è¾“å…¥ç´ æ</a>å¼€å§‹æ‰“ç£¨å§
                            </p>
                        </div>
                    `;
                    return;
                }

                this.renderLibraryList(materials);
            },

            renderLibraryList(materials) {
                const container = document.getElementById('library-list');
                const categoryNames = {
                    growth: 'æˆé•¿æ„Ÿæ‚Ÿ',
                    emotion: 'æƒ…æ„Ÿä½“éªŒ',
                    quality: 'å“è´¨ä¿®å…»',
                    culture: 'æ–‡åŒ–ä¼ æ‰¿',
                    society: 'ç¤¾ä¼šè§‚å¯Ÿ',
                    nature: 'è‡ªç„¶æ„Ÿæ‚Ÿ'
                };

                container.innerHTML = materials.map(m => {
                    const date = new Date(m.createdAt);
                    const dateStr = this.formatDate(date);
                    const score = m.scores?.overall || '--';
                    const pivotCount = m.pivots?.length || 0;

                    return `
                        <div class="library-item">
                            <div class="library-item-header">
                                <span class="library-item-title">${categoryNames[m.category] || 'æœªåˆ†ç±»'}ç´ æ</span>
                                <span class="library-item-date">${dateStr}</span>
                            </div>
                            <div class="library-item-tags">
                                ${m.tags?.map(t => `<span class="library-item-tag">#${t}</span>`).join('') || ''}
                            </div>
                            <div class="library-item-meta">
                                <span>è¯„åˆ†ï¼šâ­ ${score}/5.0</span>
                                <span>|</span>
                                <span>${pivotCount}ä¸ªä½¿ç”¨è§’åº¦</span>
                            </div>
                            <div class="library-item-actions">
                                <button class="btn btn-secondary btn-sm" onclick="app.viewMaterial('${m.id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                                <button class="btn btn-secondary btn-sm" onclick="app.deleteMaterial('${m.id}')">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            filterLibrary() {
                const search = document.getElementById('library-search').value.toLowerCase();
                const filter = document.getElementById('library-filter').value;

                let materials = Storage.getMaterials();

                if (search) {
                    materials = materials.filter(m =>
                        m.content.toLowerCase().includes(search) ||
                        m.tags?.some(t => t.toLowerCase().includes(search))
                    );
                }

                if (filter) {
                    materials = materials.filter(m => m.category === filter);
                }

                this.renderLibraryList(materials);
            },

            viewMaterial(id) {
                const materials = Storage.getMaterials();
                const m = materials.find(x => x.id === id);
                if (!m) return;

                this.currentMaterial = m;
                this.currentScore = { scores: m.scores, summary: m.summary, suggestions: m.suggestions };
                this.currentPivots = { pivots: m.pivots };

                this.renderScore(this.currentScore);
                this.showView('score');
            },

            deleteMaterial(id) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç´ æå—ï¼Ÿ')) return;

                const materials = Storage.getMaterials().filter(m => m.id !== id);
                Storage.setMaterials(materials);
                this.loadLibrary();
            },

            formatDate(date) {
                const now = new Date();
                const diff = now - date;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));

                if (days === 0) return 'ä»Šå¤©';
                if (days === 1) return 'æ˜¨å¤©';
                if (days < 7) return `${days}å¤©å‰`;
                if (days < 30) return `${Math.floor(days / 7)}å‘¨å‰`;
                return `${Math.floor(days / 30)}ä¸ªæœˆå‰`;
            },

            // æ–‡ä»¶ä¸Šä¼ å¤„ç†
            handleFileUpload(event) {
                const file = event.target.files[0];
                if (file) this.processFile(file);
            },

            processFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.uploadedFileContent = e.target.result;
                    document.getElementById('file-preview').style.display = 'block';
                    document.getElementById('file-preview').textContent =
                        this.uploadedFileContent.substring(0, 500) +
                        (this.uploadedFileContent.length > 500 ? '...' : '');
                    document.getElementById('btn-analyze').disabled = false;
                };
                reader.readAsText(file);
            },

            // åˆ†æçŸ¥è¯†åº“
            async analyzeKnowledge() {
                if (!this.uploadedFileContent) return;

                const settings = Storage.getSettings();
                if (!this.hasValidAPIKey(settings)) {
                    alert('è¯·å…ˆé…ç½®APIå¯†é’¥');
                    return;
                }

                this.showLoading('AIåˆ†æä¸­ï¼Œè¯·ç¨å€™...');

                try {
                    const result = await this.callAIAPI('analyze', this.uploadedFileContent);

                    // ä¿å­˜çŸ¥è¯†åº“
                    const knowledge = Storage.getKnowledge();
                    knowledge.beijing = {
                        enabled: true,
                        source: 'ç”¨æˆ·å¯¼å…¥',
                        data: result
                    };
                    Storage.setKnowledge(knowledge);

                    this.renderAnalysisResult(result);
                    this.updateKnowledgeStatus();
                } catch (err) {
                    alert('åˆ†æå¤±è´¥ï¼š' + err.message);
                } finally {
                    this.hideLoading();
                }
            },

            renderAnalysisResult(result) {
                document.getElementById('analysis-result').style.display = 'block';

                // ä¸»é¢˜åˆ†å¸ƒ
                const themeStats = document.getElementById('theme-stats');
                themeStats.innerHTML = (result.stats?.topThemes || [])
                    .map(t => `
                        <div class="stat-bar">
                            <span class="stat-bar-label">${t.name}</span>
                            <div class="stat-bar-fill">
                                <div class="stat-bar-progress" style="width: ${t.percentage}"></div>
                            </div>
                            <span class="stat-bar-value">${t.count}æ¬¡ (${t.percentage})</span>
                        </div>
                    `).join('');

                // å…³é”®è¯
                const keywordStats = document.getElementById('keyword-stats');
                const keywords = result.stats?.keywordFrequency || {};
                keywordStats.innerHTML = Object.entries(keywords)
                    .slice(0, 8)
                    .map(([k, v]) => `<span class="tag">${k}(${v}æ¬¡)</span>`)
                    .join('');

                // AIæ´å¯Ÿ
                document.getElementById('ai-insights').textContent =
                    result.trends || 'æš‚æ— åˆ†æç»“æœ';
            },

            updateKnowledgeStatus() {
                const knowledge = Storage.getKnowledge();
                if (knowledge.beijing?.enabled) {
                    document.getElementById('knowledge-beijing').classList.add('enabled');
                    document.getElementById('knowledge-beijing-status').textContent = 'âœ… å·²å¯¼å…¥';
                }
            },

            // è®¾ç½®
            showSettings() {
                document.getElementById('settings-modal').classList.add('active');
            },

            closeSettings() {
                document.getElementById('settings-modal').classList.remove('active');
            },

            onProviderChange() {
                const provider = document.getElementById('ai-provider').value;
                document.querySelectorAll('.provider-settings').forEach(el => {
                    el.style.display = 'none';
                });
                document.getElementById(`${provider}-settings`).style.display = 'block';
            },

            saveSettings() {
                const provider = document.getElementById('ai-provider').value;
                const settings = {
                    provider: provider,
                    openai: {
                        apiKey: document.getElementById('openai-api-key').value.trim(),
                        apiUrl: document.getElementById('openai-api-url').value.trim(),
                        model: document.getElementById('openai-model').value
                    },
                    claude: {
                        apiKey: document.getElementById('claude-api-key').value.trim(),
                        apiUrl: document.getElementById('claude-api-url').value.trim(),
                        model: document.getElementById('claude-model').value
                    },
                    gemini: {
                        apiKey: document.getElementById('gemini-api-key').value.trim(),
                        model: document.getElementById('gemini-model').value
                    },
                    kimi: {
                        apiKey: document.getElementById('kimi-api-key').value.trim(),
                        model: document.getElementById('kimi-model').value
                    },
                    minimax: {
                        apiKey: document.getElementById('minimax-api-key').value.trim(),
                        groupId: document.getElementById('minimax-group-id').value.trim(),
                        model: document.getElementById('minimax-model').value
                    },
                    azure: {
                        apiKey: document.getElementById('azure-api-key').value.trim(),
                        endpoint: document.getElementById('azure-endpoint').value.trim(),
                        deployment: document.getElementById('azure-deployment').value.trim(),
                        apiVersion: document.getElementById('azure-api-version').value
                    },
                    openrouter: {
                        apiKey: document.getElementById('openrouter-api-key').value.trim(),
                        model: document.getElementById('openrouter-model').value
                    },
                    custom: {
                        apiKey: document.getElementById('custom-api-key').value.trim(),
                        apiUrl: document.getElementById('custom-api-url').value.trim(),
                        model: document.getElementById('custom-model').value.trim(),
                        format: document.getElementById('custom-format').value
                    }
                };
                Storage.setSettings(settings);
                this.closeSettings();
                alert('è®¾ç½®å·²ä¿å­˜');
            },

            loadSettings() {
                const settings = Storage.getSettings();

                // å…¼å®¹æ—§ç‰ˆæœ¬è®¾ç½®
                if (settings.apiKey && !settings.provider) {
                    // è¿ç§»æ—§è®¾ç½®åˆ°æ–°æ ¼å¼
                    settings.provider = 'claude';
                    settings.claude = {
                        apiKey: settings.apiKey,
                        apiUrl: settings.apiUrl || '',
                        model: settings.model || 'claude-3-sonnet-20240229'
                    };
                    Storage.setSettings(settings);
                }

                if (settings.provider) {
                    document.getElementById('ai-provider').value = settings.provider;
                    this.onProviderChange();
                }
                // OpenAI
                if (settings.openai?.apiKey) {
                    document.getElementById('openai-api-key').value = settings.openai.apiKey;
                }
                if (settings.openai?.apiUrl) {
                    document.getElementById('openai-api-url').value = settings.openai.apiUrl;
                }
                if (settings.openai?.model) {
                    document.getElementById('openai-model').value = settings.openai.model;
                }
                // Claude
                if (settings.claude?.apiKey) {
                    document.getElementById('claude-api-key').value = settings.claude.apiKey;
                }
                if (settings.claude?.apiUrl) {
                    document.getElementById('claude-api-url').value = settings.claude.apiUrl;
                }
                if (settings.claude?.model) {
                    document.getElementById('claude-model').value = settings.claude.model;
                }
                // Gemini
                if (settings.gemini?.apiKey) {
                    document.getElementById('gemini-api-key').value = settings.gemini.apiKey;
                }
                if (settings.gemini?.model) {
                    document.getElementById('gemini-model').value = settings.gemini.model;
                }
                // Kimi
                if (settings.kimi?.apiKey) {
                    document.getElementById('kimi-api-key').value = settings.kimi.apiKey;
                }
                if (settings.kimi?.model) {
                    document.getElementById('kimi-model').value = settings.kimi.model;
                }
                // MiniMax
                if (settings.minimax?.apiKey) {
                    document.getElementById('minimax-api-key').value = settings.minimax.apiKey;
                }
                if (settings.minimax?.groupId) {
                    document.getElementById('minimax-group-id').value = settings.minimax.groupId;
                }
                if (settings.minimax?.model) {
                    document.getElementById('minimax-model').value = settings.minimax.model;
                }
                // Azure
                if (settings.azure?.apiKey) {
                    document.getElementById('azure-api-key').value = settings.azure.apiKey;
                }
                if (settings.azure?.endpoint) {
                    document.getElementById('azure-endpoint').value = settings.azure.endpoint;
                }
                if (settings.azure?.deployment) {
                    document.getElementById('azure-deployment').value = settings.azure.deployment;
                }
                if (settings.azure?.apiVersion) {
                    document.getElementById('azure-api-version').value = settings.azure.apiVersion;
                }
                // OpenRouter
                if (settings.openrouter?.apiKey) {
                    document.getElementById('openrouter-api-key').value = settings.openrouter.apiKey;
                }
                if (settings.openrouter?.model) {
                    document.getElementById('openrouter-model').value = settings.openrouter.model;
                }
                // Custom
                if (settings.custom?.apiKey) {
                    document.getElementById('custom-api-key').value = settings.custom.apiKey;
                }
                if (settings.custom?.apiUrl) {
                    document.getElementById('custom-api-url').value = settings.custom.apiUrl;
                }
                if (settings.custom?.model) {
                    document.getElementById('custom-model').value = settings.custom.model;
                }
                if (settings.custom?.format) {
                    document.getElementById('custom-format').value = settings.custom.format;
                }
            },

            // åŠ è½½çŠ¶æ€
            showLoading(text) {
                document.getElementById('loading-text').textContent = text;
                document.getElementById('loading').classList.add('active');
            },

            hideLoading() {
                document.getElementById('loading').classList.remove('active');
            }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
